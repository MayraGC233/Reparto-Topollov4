<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Pedidos - Materiales El Topollo</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="App de logística para registrar y actualizar pedidos de Materiales El Topollo, conectada a Google Sheets vía Apps Script" />
  <style>
    /* Toast simple */
    #toast{position:fixed;inset-inline:0;bottom:20px;margin:auto;max-width:640px;z-index:50}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-6xl mx-auto p-4 sm:p-6">
    <!-- Encabezado -->
    <header class="text-center mb-6">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-700">🚚 Materiales el Topollo</h1>
      <p class="text-sm sm:text-base italic text-gray-600">“Al servicio en la construcción de su hogar”</p>
    </header>

    <!-- Configuración (URL de Apps Script) -->
    <section class="bg-blue-50 border border-blue-100 rounded-2xl p-3 sm:p-4 mb-4">
      <p class="text-xs sm:text-sm">Pega aquí la URL del Web App de Google Apps Script (debe terminar en <code>/exec</code>):</p>
      <div class="mt-2 flex flex-col sm:flex-row gap-2">
        <input id="gasUrl" class="flex-1 border rounded-xl p-2" placeholder="https://script.google.com/macros/s/XXXXXXXXXXXX/exec" />
        <button id="saveUrlBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Guardar URL</button>
      </div>
      <p id="urlHint" class="text-xs text-gray-500 mt-1"></p>
    </section>

    <!-- Formulario -->
    <form id="pedidoForm" class="bg-white rounded-2xl shadow p-4 sm:p-6 space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold">📦 Número de Pedido</label>
          <input type="text" id="numeroPedido" class="border p-2 rounded-xl w-full" required />
        </div>
        <div>
          <label class="block text-sm font-semibold">👤 Nombre del Cliente</label>
          <input type="text" id="cliente" class="border p-2 rounded-xl w-full" />
        </div>
        <div>
          <label class="block text-sm font-semibold">🧑‍💼 Nombre del Vendedor</label>
          <input type="text" id="vendedor" class="border p-2 rounded-xl w-full" />
        </div>
        <div>
          <label class="block text-sm font-semibold">📱 Teléfono del Vendedor (opcional)</label>
          <input type="tel" id="telVendedor" class="border p-2 rounded-xl w-full" placeholder="Ej. 5215555555555" />
        </div>
        <div>
          <label class="block text-sm font-semibold">🚚 Nombre del Chofer</label>
          <input type="text" id="chofer" class="border p-2 rounded-xl w-full" />
        </div>
        <div>
          <label class="block text-sm font-semibold">📋 Estado del Pedido</label>
          <select id="estado" class="border p-2 rounded-xl w-full">
            <option value="">Seleccione estado</option>
            <option value="en espera">⏳ En espera</option>
            <option value="cargando">📦 Cargando</option>
            <option value="en ruta">🚛 En ruta</option>
            <option value="entregado">✅ Entregado</option>
            <option value="sin receptor">🚫 Sin receptor</option>
          </select>
        </div>
        <div id="tiempoEstimadoDiv" class="hidden">
          <label class="block text-sm font-semibold">⏰ Tiempo Estimado de Entrega</label>
          <input type="text" id="tiempoEstimado" class="border p-2 rounded-xl w-full" placeholder="Ej. 45 min" />
        </div>
        <div>
          <label class="block text-sm font-semibold">🏭 Hora de Salida de Bodega</label>
          <input type="time" id="horaSalida" class="border p-2 rounded-xl w-full" />
        </div>
        <div>
          <label class="block text-sm font-semibold">📍 Hora de Entrega</label>
          <input type="time" id="horaEntrega" class="border p-2 rounded-xl w-full" />
        </div>
        <div class="sm:col-span-2">
          <label class="block text-sm font-semibold">📬 Nombre de quien Recibe</label>
          <input type="text" id="recibe" class="border p-2 rounded-xl w-full" />
        </div>
        <div class="sm:col-span-2">
          <label class="block text-sm font-semibold">📑 Status Factura/Nota</label>
          <select id="statusFactura" class="border p-2 rounded-xl w-full">
            <option value="">Seleccione</option>
            <option value="cobro">💰 Cobro</option>
            <option value="firma">✍️ Firma</option>
          </select>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 pt-2">
        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700">Guardar / Actualizar</button>
        <button type="button" id="btnNuevo" class="bg-gray-100 px-5 py-2 rounded-xl border">Nuevo</button>
        <button type="button" id="btnSinReceptor" class="bg-red-50 text-red-700 px-5 py-2 rounded-xl border border-red-200">🚫 Sin Receptor</button>
        <button type="button" id="btnRefrescar" class="bg-green-600 text-white px-5 py-2 rounded-xl hover:bg-green-700">Refrescar tabla</button>
      </div>
    </form>

    <!-- Notificación visual -->
    <div id="notificacion" class="hidden text-red-700 text-center mt-4 font-semibold"></div>

    <!-- Tabla resumen -->
    <section class="mt-8">
      <h2 class="text-lg sm:text-xl font-bold mb-3">📄 Pedidos Registrados</h2>
      <div class="overflow-x-auto bg-white rounded-2xl shadow">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="p-2 border">Pedido</th>
              <th class="p-2 border">Cliente</th>
              <th class="p-2 border">Vendedor</th>
              <th class="p-2 border">Estado</th>
              <th class="p-2 border">Chofer</th>
              <th class="p-2 border">Salida</th>
              <th class="p-2 border">Entrega</th>
              <th class="p-2 border">Recibe</th>
              <th class="p-2 border">Factura/Nota</th>
            </tr>
          </thead>
          <tbody id="tablaPedidos"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="hidden">
    <div class="mx-3 sm:mx-0 bg-gray-900 text-white text-sm sm:text-base rounded-xl px-4 py-3 shadow-lg text-center"></div>
  </div>

  <script>
    // ======= CONFIG =======
    const LS_KEY_URL = 'topollo_gas_url';
    const LS_KEY_CACHE = 'topollo_cache'; // respaldo local para modo offline

    // ======= UTILS =======
    const $ = (id)=>document.getElementById(id);
    function showToast(msg, ms=2200){
      const c = $('#toast');
      c.classList.remove('hidden');
      c.firstElementChild.textContent = msg;
      setTimeout(()=>c.classList.add('hidden'), ms);
    }

    function saveGasUrl(){
      const u = $('#gasUrl').value.trim();
      if(!u){ showToast('Ingresa la URL del Web App de Apps Script'); return; }
      localStorage.setItem(LS_KEY_URL, u);
      $('#urlHint').textContent = 'URL guardada ✓';
      showToast('URL de Apps Script guardada');
    }

    function getGasUrl(){
      return localStorage.getItem(LS_KEY_URL) || '';
    }

    function cacheSet(map){
      localStorage.setItem(LS_KEY_CACHE, JSON.stringify(map));
    }
    function cacheGet(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY_CACHE)||'{}'); }catch{ return {}; }
    }

    function buildOrderFromForm(){
      return {
        numeroPedido: $('#numeroPedido').value.trim(),
        cliente: $('#cliente').value.trim(),
        vendedor: $('#vendedor').value.trim(),
        telVendedor: $('#telVendedor').value.trim(),
        chofer: $('#chofer').value.trim(),
        estado: $('#estado').value,
        tiempoEstimado: $('#estado').value==='en espera' ? $('#tiempoEstimado').value.trim() : '',
        salida: $('#horaSalida').value,
        entrega: $('#horaEntrega').value,
        recibe: $('#recibe').value.trim(),
        statusFactura: $('#statusFactura').value
      };
    }

    function fillForm(o){
      if(!o) return;
      $('#cliente').value = o.cliente||'';
      $('#vendedor').value = o.vendedor||'';
      $('#telVendedor').value = o.telVendedor||'';
      $('#chofer').value = o.chofer||'';
      $('#estado').value = o.estado||'';
      $('#horaSalida').value = o.salida||'';
      $('#horaEntrega').value = o.entrega||'';
      $('#recibe').value = o.recibe||'';
      $('#statusFactura').value = o.statusFactura||'';
      // tiempo estimado solo si aplica
      if(o.estado==='en espera'){
        $('#tiempoEstimadoDiv').classList.remove('hidden');
        $('#tiempoEstimado').value = o.tiempoEstimado||'';
      } else {
        $('#tiempoEstimadoDiv').classList.add('hidden');
        $('#tiempoEstimado').value='';
      }
    }

    function clearForm(){
      $('#pedidoForm').reset();
      $('#tiempoEstimadoDiv').classList.add('hidden');
    }

    function setSinReceptorUI(id, vendedor){
      $('#notificacion').classList.remove('hidden');
      $('#notificacion').textContent = `⚠️ No hay quien reciba el pedido #${id}. Contacta al vendedor ${vendedor} por WhatsApp.`;
      showToast('Aviso: Sin receptor');
    }

    function openWhatsApp(vendedor, tel, id, cliente){
      const text = encodeURIComponent(`Aviso: Pedido #${id} de ${cliente} no tiene quien reciba.`);
      const url = tel ? `https://wa.me/${tel}?text=${text}` : `https://wa.me/?text=${text}`;
      window.open(url, '_blank');
    }

    // ======= API =======
    async function apiGetById(id){
      const base = getGasUrl();
      if(!base) throw new Error('Sin URL de Apps Script');
      const url = `${base}?action=get&numeroPedido=${encodeURIComponent(id)}`;
      const r = await fetch(url, { method:'GET' });
      if(!r.ok) throw new Error('GET falló');
      return r.json();
    }

    async function apiList(){
      const base = getGasUrl();
      if(!base) throw new Error('Sin URL de Apps Script');
      const r = await fetch(`${base}?action=list`, { method:'GET' });
      if(!r.ok) throw new Error('LIST falló');
      return r.json();
    }

    async function apiUpsert(order){
      const base = getGasUrl();
      if(!base) throw new Error('Sin URL de Apps Script');
      const r = await fetch(base, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action:'upsert', payload: order })
      });
      if(!r.ok) throw new Error('UPSERT falló');
      return r.json();
    }

    // ======= UI Logic =======
    const tablaPedidos = $('#tablaPedidos');

    function renderTabla(map){
      tablaPedidos.innerHTML = '';
      const pedidos = Object.values(map||{});
      pedidos.sort((a,b)=> (a.numeroPedido||'').localeCompare(b.numeroPedido||''));
      for(const p of pedidos){
        const tr = document.createElement('tr');
        tr.className = 'text-center odd:bg-white even:bg-gray-50';
        tr.innerHTML = `
          <td class="border p-1">${p.numeroPedido||''}</td>
          <td class="border p-1">${p.cliente||''}</td>
          <td class="border p-1">${p.vendedor||''}</td>
          <td class="border p-1">${p.estado||''}</td>
          <td class="border p-1">${p.chofer||''}</td>
          <td class="border p-1">${p.salida||''}</td>
          <td class="border p-1">${p.entrega||''}</td>
          <td class="border p-1">${p.recibe||'—'}</td>
          <td class="border p-1">${p.statusFactura||'—'}</td>`;
        tablaPedidos.appendChild(tr);
      }
    }

    async function cargarTabla(){
      try{
        const data = await apiList(); // { ok:true, rows:[...] }
        const map = {};
        for(const r of (data.rows||[])) map[r.numeroPedido]=r;
        cacheSet(map);
        renderTabla(map);
        showToast('Tabla actualizada');
      }catch(e){
        // modo offline con cache
        renderTabla(cacheGet());
        showToast('Sin conexión al script: usando datos en caché');
      }
    }

    async function buscarYAutocompletar(id){
      if(!id) return;
      // 1) cache inmediata
      const cache = cacheGet();
      if(cache[id]) fillForm(cache[id]);
      // 2) servidor
      try{
        const data = await apiGetById(id); // { ok:true, row:{...} }
        if(data && data.row){
          const map = cacheGet();
          map[id]=data.row;
          cacheSet(map);
          fillForm(data.row);
        }
      }catch(e){ /* keep cache */ }
    }

    // ======= Event Listeners =======
    $('#saveUrlBtn').addEventListener('click', saveGasUrl);
    $('#estado').addEventListener('change', ()=>{
      const show = $('#estado').value==='en espera';
      $('#tiempoEstimadoDiv').classList.toggle('hidden', !show);
    });
    $('#numeroPedido').addEventListener('blur', (e)=> buscarYAutocompletar(e.target.value.trim()));
    $('#btnNuevo').addEventListener('click', clearForm);
    $('#btnRefrescar').addEventListener('click', cargarTabla);

    $('#btnSinReceptor').addEventListener('click', ()=>{
      const id = $('#numeroPedido').value.trim();
      const vendedor = $('#vendedor').value.trim();
      const tel = $('#telVendedor').value.trim();
      const cliente = $('#cliente').value.trim();
      if(!id){ showToast('Ingresa el número de pedido'); return; }
      setSinReceptorUI(id, vendedor||'(sin vendedor)');
      openWhatsApp(vendedor, tel, id, cliente);
    });

    $('#pedidoForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const order = buildOrderFromForm();
      if(!order.numeroPedido){ showToast('Número de pedido requerido'); return; }
      try{
        const res = await apiUpsert(order);
        if(!(res && res.ok)) throw new Error('Respuesta inválida');
        // actualizar cache local
        const map = cacheGet();
        map[order.numeroPedido]=order;
        cacheSet(map);
        await cargarTabla();
        clearForm();
        showToast('Pedido guardado');
      }catch(err){
        // Fallback offline: guardamos localmente
        const map = cacheGet();
        map[order.numeroPedido]=order;
        cacheSet(map);
        renderTabla(map);
        clearForm();
        showToast('Guardado en caché (sin conexión al script)');
      }
    });

    // ======= Init =======
    (function init(){
      const saved = getGasUrl();
      if(saved){ $('#gasUrl').value = saved; $('#urlHint').textContent = 'URL cargada de almacenamiento local'; }
      cargarTabla();
    })();
  </script>

  <!-- ===================== APPS SCRIPT (Code.gs) =====================
     Pega este código en un proyecto de Google Apps Script (Extensiones > Apps Script),
     vinculado a una hoja de cálculo. Ajusta el nombre de hoja en SHEET_NAME.
     Luego despliega como Web App (Implementar > Implementar como aplicación web):
       - Ejecutar como: Tu cuenta
       - Quién tiene acceso: Cualquiera con el enlace
     IMPORTANTE: La URL que terminas con /exec pégala arriba en la app.
  -->
  <!--
const SHEET_NAME = 'Pedidos';

function _ss(){
  const id = SpreadsheetApp.getActiveSpreadsheet().getId();
  return SpreadsheetApp.openById(id).getSheetByName(SHEET_NAME) || SpreadsheetApp.getActiveSpreadsheet().insertSheet(SHEET_NAME);
}

function doOptions(e){
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
}

function _cors(json){
  return ContentService.createTextOutput(JSON.stringify(json))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({ 'Access-Control-Allow-Origin': '*' });
}

function doGet(e){
  try{
    const action = (e.parameter.action||'').toLowerCase();
    if(action==='list'){
      const sheet = _ss();
      const values = sheet.getDataRange().getValues();
      const headers = values[0]||[];
      const rows = [];
      for(let i=1;i<values.length;i++){
        const r = values[i];
        if(!r[0]) continue; // numeroPedido requerido
        rows.push({
          numeroPedido: r[0], cliente:r[1], vendedor:r[2], telVendedor:r[3], chofer:r[4], estado:r[5], tiempoEstimado:r[6], salida:r[7], entrega:r[8], recibe:r[9], statusFactura:r[10]
        });
      }
      return _cors({ ok:true, rows });
    }
    if(action==='get'){
      const id = e.parameter.numeroPedido;
      if(!id) return _cors({ ok:false, message:'numeroPedido requerido' });
      const sheet = _ss();
      const values = sheet.getDataRange().getValues();
      for(let i=1;i<values.length;i++){
        if(values[i][0]==id){
          const r = values[i];
          return _cors({ ok:true, row:{
            numeroPedido:r[0], cliente:r[1], vendedor:r[2], telVendedor:r[3], chofer:r[4], estado:r[5], tiempoEstimado:r[6], salida:r[7], entrega:r[8], recibe:r[9], statusFactura:r[10]
          }});
        }
      }
      return _cors({ ok:true, row:null });
    }
    return _cors({ ok:false, message:'Acción GET no reconocida' });
  }catch(err){ return _cors({ ok:false, message:String(err) }); }
}

function doPost(e){
  try{
    const body = e.postData && e.postData.contents ? JSON.parse(e.postData.contents) : {};
    const action = (body.action||'').toLowerCase();
    if(action==='upsert'){
      const p = body.payload||{};
      if(!p.numeroPedido) return _cors({ ok:false, message:'numeroPedido requerido' });
      const sheet = _ss();
      // asegura encabezados
      if(sheet.getLastRow()===0){
        sheet.appendRow(['numeroPedido','cliente','vendedor','telVendedor','chofer','estado','tiempoEstimado','salida','entrega','recibe','statusFactura']);
      }
      const values = sheet.getDataRange().getValues();
      let rowIndex = -1;
      for(let i=1;i<values.length;i++) if(values[i][0]==p.numeroPedido){ rowIndex=i+1; break; }
      const row = [p.numeroPedido,p.cliente,p.vendedor,p.telVendedor,p.chofer,p.estado,p.tiempoEstimado,p.salida,p.entrega,p.recibe,p.statusFactura];
      if(rowIndex>0){ sheet.getRange(rowIndex,1,1,row.length).setValues([row]); }
      else { sheet.appendRow(row); }
      return _cors({ ok:true });
    }
    return _cors({ ok:false, message:'Acción POST no reconocida' });
  }catch(err){ return _cors({ ok:false, message:String(err) }); }
}
  -->
</body>
</html>
